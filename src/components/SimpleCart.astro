---
// Simple cart button component
---

<button id="cart-button" class="cart-float-btn" aria-label="Ver carrito">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
    </svg>
    <span id="cart-count" class="cart-count-badge hidden">0</span>
</button>

<div id="cart-panel" class="cart-panel">
    <div class="cart-panel-header">
        <h3 class="cart-panel-title">
            Carrito (<span id="cart-total">0</span>)
        </h3>
        <button id="cart-close" class="cart-close-btn" aria-label="Cerrar">
            <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <div id="cart-items" class="cart-panel-items"></div>

    <div id="cart-footer" class="cart-panel-footer hidden">
        <button id="send-whatsapp" class="cart-whatsapp-btn">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path
                    d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"
                ></path>
            </svg>
            Enviar por WhatsApp
        </button>
        <button id="clear-cart" class="cart-clear-btn">Vaciar Carrito</button>
    </div>
</div>

<div id="cart-overlay" class="cart-overlay"></div>

<script>
    import {
        getCartItems,
        getCartCount,
        removeFromCart,
        updateQuantity,
        clearCart,
        generateWhatsAppMessage,
    } from "../lib/cart.js";

    const cartButton = document.getElementById("cart-button");
    const cartPanel = document.getElementById("cart-panel");
    const cartOverlay = document.getElementById("cart-overlay");
    const cartClose = document.getElementById("cart-close");
    const cartCount = document.getElementById("cart-count");
    const cartTotal = document.getElementById("cart-total");
    const cartItemsContainer = document.getElementById("cart-items");
    const cartFooter = document.getElementById("cart-footer");
    const sendWhatsAppBtn = document.getElementById("send-whatsapp");
    const clearCartBtn = document.getElementById("clear-cart");

    function openCart() {
        cartPanel?.classList.add("open");
        cartOverlay?.classList.add("visible");
        document.body.style.overflow = "hidden";
    }

    function closeCart() {
        cartPanel?.classList.remove("open");
        cartOverlay?.classList.remove("visible");
        document.body.style.overflow = "";
    }

    function renderCart() {
        const items = getCartItems();
        const count = getCartCount();

        // Update badge
        if (cartCount) {
            if (count > 0) {
                cartCount.textContent = count.toString();
                cartCount.classList.remove("hidden");
            } else {
                cartCount.classList.add("hidden");
            }
        }

        // Update total
        if (cartTotal) {
            cartTotal.textContent = count.toString();
        }

        // Render items
        if (cartItemsContainer) {
            if (items.length === 0) {
                cartItemsContainer.innerHTML = `
          <div class="cart-empty">
            <svg class="cart-empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
            </svg>
            <p class="cart-empty-text">Tu carrito está vacío</p>
          </div>
        `;
                cartFooter?.classList.add("hidden");
            } else {
                cartItemsContainer.innerHTML = items
                    .map(
                        (item) => `
          <div class="cart-item">
            <img src="${item.image}" alt="${item.name}" class="cart-item-img">
            <div class="cart-item-info">
              <h4 class="cart-item-name">${item.name}</h4>
              <p class="cart-item-cat">${item.category}</p>
              <div class="cart-item-controls">
                <button class="cart-qty-btn" onclick="window.updateCartQty('${item.id}', ${item.quantity - 1})">-</button>
                <span class="cart-qty">${item.quantity}</span>
                <button class="cart-qty-btn" onclick="window.updateCartQty('${item.id}', ${item.quantity + 1})">+</button>
                <button class="cart-remove-btn" onclick="window.removeCartItem('${item.id}')" aria-label="Eliminar">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        `,
                    )
                    .join("");
                cartFooter?.classList.remove("hidden");
            }
        }
    }

    // Global functions for inline handlers
    window.updateCartQty = (id, qty) => {
        updateQuantity(id, qty);
    };

    window.removeCartItem = (id) => {
        removeFromCart(id);
    };

    // Event listeners
    cartButton?.addEventListener("click", openCart);
    cartClose?.addEventListener("click", closeCart);
    cartOverlay?.addEventListener("click", closeCart);

    sendWhatsAppBtn?.addEventListener("click", () => {
        const message = generateWhatsAppMessage();
        window.open(`https://wa.me/56912345678?text=${message}`, "_blank");
    });

    clearCartBtn?.addEventListener("click", () => {
        if (confirm("¿Vaciar el carrito?")) {
            clearCart();
        }
    });

    // Listen for cart updates
    window.addEventListener("cart-updated", renderCart);

    // Initial render
    renderCart();
</script>

<style>
    .cart-float-btn {
        position: fixed;
        bottom: 7rem;
        right: 2rem;
        z-index: 999;
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #0891b2 0%, #0284c7 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: 0 8px 24px rgba(8, 145, 178, 0.4);
        transition: all 0.3s ease;
        border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .cart-float-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 32px rgba(8, 145, 178, 0.6);
    }

    .cart-count-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        color: white;
        font-size: 0.75rem;
        font-weight: 700;
        min-width: 24px;
        height: 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 6px;
        box-shadow: 0 2px 8px rgba(249, 115, 22, 0.4);
        animation: pulse 2s infinite;
    }

    .cart-panel {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        max-width: 420px;
        background: white;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .cart-panel.open {
        transform: translateX(0);
    }

    .cart-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 2px solid #f1f5f9;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    }

    .cart-panel-title {
        font-size: 1.5rem;
        font-weight: 900;
        color: #1e293b;
    }

    .cart-close-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: #f1f5f9;
        color: #64748b;
        transition: all 0.2s ease;
    }

    .cart-close-btn:hover {
        background: #e2e8f0;
        color: #0891b2;
        transform: rotate(90deg);
    }

    .cart-panel-items {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }

    .cart-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        padding: 2rem;
    }

    .cart-empty-icon {
        width: 6rem;
        height: 6rem;
        color: #cbd5e1;
        margin-bottom: 1rem;
    }

    .cart-empty-text {
        font-size: 1.125rem;
        font-weight: 600;
        color: #64748b;
    }

    .cart-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 1rem;
        margin-bottom: 1rem;
        border: 2px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .cart-item:hover {
        border-color: #0891b2;
    }

    .cart-item-img {
        width: 80px;
        height: 80px;
        object-fit: contain;
        background: white;
        border-radius: 0.5rem;
        padding: 0.5rem;
    }

    .cart-item-info {
        flex: 1;
    }

    .cart-item-name {
        font-weight: 700;
        font-size: 0.875rem;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }

    .cart-item-cat {
        font-size: 0.75rem;
        color: #64748b;
        margin-bottom: 0.5rem;
    }

    .cart-item-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .cart-qty-btn {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 0.375rem;
        color: #64748b;
        font-weight: 700;
        transition: all 0.2s ease;
    }

    .cart-qty-btn:hover {
        background: linear-gradient(135deg, #0891b2 0%, #0284c7 100%);
        color: white;
        border-color: transparent;
    }

    .cart-qty {
        min-width: 32px;
        text-align: center;
        font-weight: 700;
        color: #1e293b;
    }

    .cart-remove-btn {
        margin-left: auto;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        background: #fee2e2;
        color: #dc2626;
        transition: all 0.2s ease;
    }

    .cart-remove-btn:hover {
        background: #dc2626;
        color: white;
    }

    .cart-panel-footer {
        padding: 1.5rem;
        border-top: 2px solid #f1f5f9;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .cart-whatsapp-btn {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
        color: white;
        font-weight: 700;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }

    .cart-whatsapp-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(37, 211, 102, 0.4);
    }

    .cart-clear-btn {
        width: 100%;
        padding: 0.75rem;
        background: #f1f5f9;
        color: #64748b;
        font-weight: 600;
        border-radius: 0.75rem;
        transition: all 0.2s ease;
    }

    .cart-clear-btn:hover {
        background: #e2e8f0;
        color: #dc2626;
    }

    .cart-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .cart-overlay.visible {
        opacity: 1;
        pointer-events: all;
    }

    @media (max-width: 640px) {
        .cart-panel {
            max-width: 100%;
        }

        .cart-float-btn {
            width: 56px;
            height: 56px;
            bottom: 6rem;
            right: 1.5rem;
        }
    }
</style>
